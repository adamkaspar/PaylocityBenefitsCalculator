using Api.Dtos.Paycheck;
using Api.Infrastructure;
using Api.Models;
using Api.Repositories;
using Mapster;
using Microsoft.Extensions.Options;

namespace Api.Services;

public class PaycheckService(IEmployeesRepository employeesRepository, IOptions<PaycheckSettings> paycheckSettings) : IPaycheckService
{
    public readonly IEmployeesRepository employeesRepository = employeesRepository;

    public readonly PaycheckSettings paycheckSettings = paycheckSettings.Value;

    public GetPaycheckDto? Get(int id, CancellationToken cancellationToken = default)
    {
        var paychecks = GetAll();
        var result = paychecks.FirstOrDefault(paycheck => paycheck.Id == id);

        return result;
    }

    public List<GetPaycheckDto> GetAll(CancellationToken cancellationToken = default)
    {
        var employees = employeesRepository.GetAll();
        var result = new List<GetPaycheckDto>();

        employees.ForEach(employee => result.AddRange(ComputePaychecks(employee).Adapt<List<GetPaycheckDto>>()));

        return result;
    }

    public List<GetPaycheckDto> GetByEmployeeId(int id, CancellationToken cancellationToken = default)
    {
        var employee = employeesRepository.Get(id);
        var result = new List<GetPaycheckDto>();

        if (employee != null)
        {
            result.AddRange(ComputePaychecks(employee).Adapt<List<GetPaycheckDto>>());
        }

        return result;
    }

    private List<Paycheck> ComputePaychecks(Employee employee, CancellationToken cancellationToken = default)
    {
        //employee annual salary
        var totalAmount = employee.Salary;
        //employees have a base cost of $1,000 per month (for benefits)
        totalAmount -= paycheckSettings.EmployeeBaseCost * 12;
        //each dependent represents an additional $600 cost per month (for benefits)
        totalAmount -= employee.Dependents.Count * paycheckSettings.DependentBaseCost * 12;
        //employees that make more than $80,000 per year will incur an additional 2% of their yearly salary in benefits costs
        if (employee.Salary > paycheckSettings.EmployeeYearLimit)
        {
            totalAmount -= employee.Salary * paycheckSettings.EmployeeAdditionalCost;
        }
        //dependents that are over 50 years old will incur an additional $200 per month
        var dependantsOverFifty = employee.Dependents.Count(dependent => (new DateTime((DateTime.Now - dependent.DateOfBirth).Ticks).Year - 1) > paycheckSettings.DependentAgeLimit);

        totalAmount -= dependantsOverFifty * paycheckSettings.DependentAdditionalCost * 12;

        //26 paychecks per year with deductions spread as evenly as possible on each paycheck
        totalAmount /= paycheckSettings.NumberOfPaychecksPerYear;

        var result = new List<Paycheck>();

        for (var i = 1; i <= paycheckSettings.NumberOfPaychecksPerYear; i++)
        {
            var week = i * 2;

            result.Add(new Paycheck
            {
                Id = employee.Id * 1000 + week, //computation just for this example, in real application, Id should be generated by Db
                Employee = employee,
                Week = week,
                Year = DateTime.Now.Year,
                TotalAmount = totalAmount
            });
        }

        return result;
    }
}